<html>
  <head>
  <style> th { text-align: left; } </style>

    <script src='/static/jquery.js'></script>
    <script>
      function to_hex_string(data)
      {
        return (data.split('').map (function (c) { return (c.charCodeAt(0) < 16 ? '0' : '') + c.charCodeAt(0).toString(16); })).join(' ')
      }

      function load_header(id)
      {
        var div = $("<div>Loading header...</div>")

        $.getJSON("/header/" + id, {}, function(data) {
          table = $('<table></table>');
          table.append($("<tr><td>Name</td><td>Value</td></tr>"));

          if(typeof data['header']['base'] != "undefined")
            table.append($("<td>Base address</td><td>0x" + data['header']['base'].toString(16) + "</td></tr>"));
          table.append("<tr><td>Entrypoint</td><td>0x" + data['header']['entrypoint'].toString(16) + "</td></tr>");

          div.html(table)
        })

        return div
      }

      function load_symbols(id)
      {
        var div = $("<div>Loading symbols...<//div>")

        $.getJSON("/symbols/" + id, {}, function(data) {
          table = $("<table></table>");

          table.append("<tr><th width='200'>Address</th><th width='500'>Name</th><th width='200'>Size</th></tr>");
          for(s in data['symbols'])
          {
            s = data['symbols'][s];

            row = $('<tr></tr>');
            row.append($("<td>0x" + s['offset'].toString(16) + "</td>"));
            row.append($("<td>"   + s['name'] + "</td>"));
            row.append($("<td>0x" + s['size'].toString(16) + "</td>"));

            table.append(row);
          }

          div.html(table);
        })

        return div
      }

      function load_imports(id)
      {
        var div = $("<div>Loading imports...</div>");

        $.getJSON("/imports/" + id, {}, function(data) {
          table = $("<table></table>");

          table.append("<tr><th width='200'>Address</th><th width='500'>Target</th><th width='200'>Hint</th></tr>");
          for(i in data['imports'])
          {
            for(j in data['imports'][i])
            {
              row = $('<tr></tr>');
              row.append("<td>" + i + "</td>");
              if(data['imports'][i][j]['target'])
                row.append($("<td>" + data['imports'][i][j]['target'].toString(16) + "</td>"));
              if(data['imports'][i][j]['hint'])
                row.append($("<td>0x" + data['imports'][i][j]['hint'].toString(16) + "</td>"));

              table.append(row);
            }
          }

          div.html(table);
        })

        return div;
      }

      function load_exports(id)
      {
        var div = $("<div>Loading exports...</div>");

        $.getJSON("/exports/" + id, {}, function(data) {
          table = $("<table></table>");

          table.append("<tr><th width='200'>Address</th><th width='200'>Ordinal</th><th width='500'>Name</th></tr>");
          for(e in data['exports'])
          {
            e = data['exports'][e];

            row = $('<tr></tr>');
            row.append($("<td>0x" + e['address'].toString(16) + "</td>"));
            row.append($("<td>" + e['ordinal'] + "</td>"));
            row.append($("<td>" + e['name'] + "</td>"));

            table.append(row);
          }

          div.html(table);
        })

        return div;
      }

      function load_code(name, data_ref)
      {
        var div = $('<div>Loading ' + name + '...</div>');

        $.getJSON("/disassemble/" + data_ref, {}, function(data) {
          table = $("<table></table>");
          for(i in data['instructions'])
          {
            i = data['instructions'][i];

            tr = $('<tr>');
            tr.append($("<td>0x" + i['address'].toString(16) + "</td>"));
            tr.append($("<td>" + to_hex_string(atob(i['bytes'])) + "</td>"));
            tr.append($("<td>" + i['name'] + "</td>"));
            tr.append($("<td>" + i['args'].join(', ') + "</td>"));

            table.append(tr);
          }
          div.html(table);
        })

        return div;
      }

      function load_sections(id)
      {
        var div = $("<div>Loading sections...</div>");

        $.getJSON("/sections/" + id, {}, function(data) {
          div.html('');

          for(s in data['sections'])
          {
            s = data['sections'][s];
            name = s['name'];
            clean_name = name.replace(/[^a-zA-Z0-9_]/g, '_');

            div.append($("<h2>" + name + " (0x" + s['file_size'].toString(16) + " bytes)</h2>"));
            div.append(create_loadable(clean_name, load_code, [name, s['data_ref']]));
          }
        })

        return div;
      }

      function create_loadable(name, load_function, params)
      {
        var out         = $("<div></div>");
        var placeholder = $("<input type='button' value='Load' id='" + name + "_placeholder' />");
        var main        = $("<div id='" + name + "' style='display: none;'></div>");
        placeholder.click(function() {
          $(this).hide();

          hide = $("<input type='button' value='Hide'>")
          hide.click(function() {
            $('#' + name + '_placeholder').show();
            $('#' + name).hide();
            $('#' + name).text('');
          })

          $('#' + name).show();
          $('#' + name).append(hide);
          $('#' + name).append(load_function.apply(this, params));
        })

        out.append(placeholder);
        out.append(main);

        return out;
      }


      function load(id)
      {
        $('#list_container').hide();
        $('#top_container').show();

        var out = $('#top_container');

        out.html("<p><a href='#' onClick='show_list()'>Show files</a></p>");

        out.append('Working...');

        out.append("<h1>Header</h1>");
        out.append(create_loadable('header', load_header, [id]))

        out.append($('<h1>Symbols</h1>'));
        out.append(create_loadable('symbols', load_symbols, [id]));

        out.append($('<h1>Imports</h1>'));
        out.append(create_loadable('imports', load_imports, [id]));

        out.append($('<h1>Exports</h1>'));
        out.append(create_loadable('exports', load_exports, [id]));

        out.append($('<h1>Sections</h1>'));
        out.append(create_loadable('sections', load_sections, [id]));
      }

      function show_list()
      {
        $('#top_container').hide();
        $('#list_container').show();
        $('#list').text('');

        $.getJSON("/list", {}, function(data) {
          for(key in data) {
            value = data[key];
            $('#list').append("<li><a href='#" + value + "' onClick=load('" + value + "');>" + value + "</a></li>");
          }
        });
      }

      $(document).ready(function() {
        if(document.location.hash == "" || document.location.hash == '#')
        {
          show_list();
        }
        else
        {
          load(document.location.hash.substring(1));
        }
      });

    </script>
  </head>

  <body>
    <div id="list_container" style="display: none;">
      <p>You can upload files here; you should get the id back as JSON, which will then appear in the list (yeah, that's ugly, but that's what you get for now :) )</p>
      <form action='/upload_html' method='post' enctype='multipart/form-data'>
        <input type='file' name='file' />
        <input type='submit' name='upload' />
      </form>
      <ul id="list"></ul>
    </div>
    <div id="top_container" style="display: none;">
    </div>
  </body>
</html>
